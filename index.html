<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SQL Extra Space Remover</title>
  <style>
    :root { --maxw:900px; --pad:16px; }
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width:var(--maxw); margin:36px auto; padding:0 var(--pad); color:#111; }
    h1 { margin:0 0 6px 0; font-size:1.4rem; }
    p { margin:0 0 14px 0; color:#444; }
    textarea { width:100%; min-height:220px; padding:12px; font-family: monospace; font-size:13px; box-sizing:border-box; border-radius:8px; border:1px solid #e6e6e6; resize:vertical; }
    .controls { display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    button { padding:8px 12px; border-radius:8px; border:1px solid #ccc; background:#f6f6f6; cursor:pointer; min-width:120px; }
    button.secondary { background:#fff; }
    label.small { font-size:13px; color:#666; display:flex; align-items:center; gap:8px; }
    .meta { margin-top:8px; color:#666; font-size:13px; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .output { white-space:pre-wrap; background:#fafafa; padding:12px; border:1px dashed #e0e0e0; margin-top:12px; font-family:monospace; border-radius:8px; min-height:80px; }
    footer { margin-top:22px; color:#666; font-size:13px; }
    .toast { position:fixed; right:20px; bottom:20px; background:#111; color:#fff; padding:10px 14px; border-radius:8px; opacity:0; transform:translateY(6px); transition:opacity .22s, transform .22s; pointer-events:none; }
    .toast.show { opacity:1; transform:translateY(0); pointer-events:auto; }
    .spinner { display:inline-block; width:16px; height:16px; border:2px solid rgba(0,0,0,0.15); border-top-color:#333; border-radius:50%; animation:spin .8s linear infinite; vertical-align:middle; margin-left:6px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .flex-between { display:flex; justify-content:space-between; gap:12px; align-items:center; flex-wrap:wrap; }
  </style>
</head>
<body>
  <h1>SQL Extra Space Remover</h1>
  <p>Paste SQL or text — collapse repeated spaces/tabs/newlines into single spaces. Optionally save cleaned + original to a  Sheet (opt-in).</p>

  <textarea id="in" placeholder="Paste SQL / procedure here...">SELECT  *   FROM   customers  WHERE  name  =  'John   Doe'  ;</textarea>

  <div class="controls">
    <button id="clean">Remove extra spaces</button>
    <button id="preserve">Collapse (preserve inside quotes)</button>
    <button id="copy">Copy output</button>
    <button id="clear" class="secondary">Clear input</button>

    <label class="small" style="margin-left:8px;">
      <input type="checkbox" id="saveToSheet" style="transform:scale(1.05)"/>
      Save to  Sheet (opt-in)
    </label>
  </div>

  <div class="meta">
    <div class="small">Tip: Use "preserve" to keep spaces inside string literals (e.g. 'John   Doe').</div>
    <div id="status" style="font-size:13px;color:#666"></div>
  </div>

  <div class="output" id="out" aria-live="polite"></div>

  <footer>Made by Blue — title: <strong>sql extra space remover</strong></footer>

  <div id="toast" class="toast"></div>

  <script>
    // ----- CONFIG: replace with your Apps Script web app URL -----
    const WEB_APP_URL = "https://script..com/macros/s/AKfycbwjFug3Ec7DVn4DME5DqKyLKaGW-JWQrkoSPhPMSYug3eHChHfNhhKKDPm0lsck3-2Cng/exec"; // <- replace me
    const WRITE_TOKEN = "535a437e64979f710a8e25fa2fa9a9055a0bc7d4ae077e0819c45c58cc0d3dde"; // <- optional: set same token in Apps Script for basic auth

    // ----- helpers: whitespace collapse functions -----
    function collapseSimple(s){
      // collapse all whitespace to single spaces, normalize some punctuation spacing, trim ends
      return s
        .replace(/\s+/g, ' ')
        .replace(/\s*,\s*/g, ', ')
        .replace(/\s*\(\s*/g, ' (')
        .replace(/\s*\)\s*/g, ') ')
        .replace(/\s*;\s*$/g, ';')
        .trim();
    }

    function collapsePreserveQuotes(s){
      // Split into segments outside/inside quotes and collapse only outside segments
      const parts = [];
      let i = 0, N = s.length;
      while(i < N){
        if (s[i] === "'" || s[i] === '"'){
          const quote = s[i];
          let j = i+1;
          while(j < N){
            if (s[j] === '\\') { j += 2; continue; } // skip escaped
            if (s[j] === quote) { j++; break; }
            j++;
          }
          parts.push({t:'q', v:s.slice(i, j)});
          i = j;
        } else {
          let j = i;
          while(j < N && s[j] !== "'" && s[j] !== '"') j++;
          parts.push({t:'o', v:s.slice(i, j)});
          i = j;
        }
      }
      return parts.map(p => p.t === 'o' ? collapseSimple(p.v) : p.v).join('').trim();
    }

    // ----- DOM refs -----
    const inEl = document.getElementById('in');
    const outEl = document.getElementById('out');
    const saveCheckbox = document.getElementById('saveToSheet');
    const statusEl = document.getElementById('status');
    const toastEl = document.getElementById('toast');

    function showToast(msg, timeout = 2600){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=> toastEl.classList.remove('show'), timeout);
    }

    // send to  Sheet (Apps Script) — returns true/false
    async function sendToSheet(cleaned, original){
      if (!WEB_APP_URL || WEB_APP_URL.includes('AKfy...')) {
        console.warn('WEB_APP_URL not configured; skipping save.');
        return false;
      }
      try {
        statusEl.innerHTML = 'Saving <span class="spinner" aria-hidden="true"></span>';
        const body = { cleaned: cleaned, original: original };
        if (WRITE_TOKEN) body.token = WRITE_TOKEN;

        // include userAgent as query param (Apps Script can read e.parameter)
        const url = WEB_APP_URL + `?_user_agent=${encodeURIComponent(navigator.userAgent || '')}`;

        const resp = await fetch(url, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify(body),
          mode: 'cors'
        });

        const text = await resp.text();
        // try parse JSON, but be tolerant
        let j = null;
        try { j = JSON.parse(text || '{}'); } catch (e) { j = null; }

        statusEl.textContent = '';
        if (resp.ok && j && j.status === 'ok') {
          showToast('Saved to  Sheet');
          return true;
        } else {
          console.warn('Save failed', resp.status, text);
          showToast('Save failed');
          return false;
        }
      } catch (e) {
        console.error('sendToSheet error', e);
        statusEl.textContent = '';
        showToast('Save error');
        return false;
      }
    }

    // ----- button handlers -----
    document.getElementById('clean').onclick = async () => {
      const cleaned = collapseSimple(inEl.value || '');
      outEl.textContent = cleaned;
      if (saveCheckbox.checked) {
        // do not block UI — but await to show toast/status
        await sendToSheet(cleaned, inEl.value || '');
      }
    };

    document.getElementById('preserve').onclick = async () => {
      const cleaned = collapsePreserveQuotes(inEl.value || '');
      outEl.textContent = cleaned;
      if (saveCheckbox.checked) {
        await sendToSheet(cleaned, inEl.value || '');
      }
    };

    document.getElementById('copy').onclick = async () => {
      try {
        const text = outEl.textContent || '';
        if (!text) { showToast('Nothing to copy'); return; }
        await navigator.clipboard.writeText(text);
        showToast('Copied to clipboard');
      } catch (e) {
        // fallback: select and let user copy manually
        showToast('Copy failed — select and copy manually');
      }
    };

    document.getElementById('clear').onclick = () => {
      inEl.value = '';
      outEl.textContent = '';
    };

    // initial populate
    outEl.textContent = collapsePreserveQuotes(inEl.value || '');
  </script>
</body>
</html>
